<!DOCTYPE html>
<html>
<head>
    <title>⧉</title>
    <style>
        body {
            background-color: black;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }

        .addButton {
            position: absolute;
            top: 10%;
            right: 10%;
            background-color: black;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 5vw;
            opacity: 0.15;
            transition: opacity 3.3s ease-in-out, visibility 0s 1s;
        }

        .addButton:hover {
            opacity: 0.9;
            transition: opacity 3.3s ease-in-out;
        }

.addButton.active {
    opacity: 0.9;
}

        .openButton {
            background-color: black;
            color: white;
            border: none;
            cursor: pointer;
            padding: 5%;
            font-size: 20vw;
            opacity: 0.2;
            transition: opacity 3.3s ease-in-out, visibility 0s 1s;
        }

        .openButton:hover {
            opacity: 0.9;
            transition: opacity 3.3s ease-in-out;
        }
    </style>
</head>
<body>
    <button class="addButton" onclick="add_link()">+</button>
    <button class="openButton" onclick="open_file_chooser()">⧉</button>

    <script>
        var savedLinks = [];

function add_link() {

    var hint = "LINK";
    if (savedLinks.length > 0) {
        hint += " (" + savedLinks.join(", ") + ")";
    }
    
    var linkUrl = prompt(hint);
    
    if (linkUrl === null || linkUrl.trim() === "") {
        savedLinks = [];
        updateButtonOpacity();
    } else {
        savedLinks = [linkUrl];
        updateButtonOpacity();
    }
}

function updateButtonOpacity() {
    var addButton = document.querySelector(".addButton");
    addButton.classList.toggle("active", savedLinks.length === 1);
}

        function open_file_chooser() {
            var fileInput = document.createElement("input");
            fileInput.type = "file";
            fileInput.click();
            fileInput.addEventListener("change", function () {
                var selectedFile = this.files[0];
                if (selectedFile) { 
                processAndSendImage(selectedFile);

                }
            });
        }

        function processAndSendImage(selectedFile) {
            var canvas = document.createElement("canvas");
            var ctx = canvas.getContext("2d");
            var img = new Image();

            img.onload = function () {
                canvas.width = 11;
                canvas.height = 11;
                ctx.drawImage(img, 0, 0, 11, 11);

                var imageData = ctx.getImageData(0, 0, 11, 11).data;
                var processedImage = [];

                for (var i = 0; i < imageData.length; i += 4) {
                    var pixel = [imageData[i], imageData[i + 1], imageData[i + 2]];
                    processedImage.push(pixel.reverse());
                }

                var processedWavesequence = processedImage.join(",");

                
                var formData = new FormData();
                formData.append("wavesequence", processedWavesequence);

                var url = savedLinks[0] ? 'http://34.175.91.146:8888/ARCHIVE?link=' + encodeURIComponent(savedLinks[0]) + '&wavesequence=' + encodeURIComponent(processedWavesequence) : 'http://34.175.91.146:8888/FRAME';

                var formData = new FormData();
                formData.append("wavesequence", processedWavesequence);

                fetch(url, {
                    method: 'POST',
                    body: formData,
                })
                .then(function (response) {
                    if (response.status === 201) {
                        savedLinks = [];
                        updateButtonOpacity();
                    } else if (response.status === 200) {
                        return response.text();
                    } else {
                        console.error('Failed to send data to the server.');
                    }
                })
                .then(function (url) {
                    if (url) {
                        if (!/^https?:\/\//i.test(url)) {
                            url = 'https://' + url;
                        }
                        window.open(url, '_blank');
                    }
                })
                .catch(function (error) {
                    console.error('Error:', error);
                });
            };

            img.src = URL.createObjectURL(selectedFile);
        }
    </script>
</body>
</html>
